{"timestamp": "2025-12-29T06:38:20.706558", "scenario": "Acid Spike", "initial_ph": 2.8, "thinking": "The control strategy must prioritize survival over speed. We will implement **incremental pulse dosing** with enforced mixing delays, not PID - PID's integral term would wind up dangerously during sensor lag and cause catastrophic overshoot. Each dose will be 5% of the calculated total requirement, followed by 15-minute mixing periods. pH probes at extreme ranges have 30-90 second response times plus mixing lag - we must wait for true reading before next dose. Use 1N KOH solution (safer than NaOH for plants) at 56g/L concentration. Calculate total KOH needed using: moles H+ = 10^(-pH) \u00d7 volume(L) \u00d7 1000, then subtract target H+ concentration. For pH 2.8\u21926.2 in 5000L: ~1,850g pure KOH required. But this is theoretical - actual need depends on buffering. Therefore, we dose incrementally and measure. Safety interlocks: if pH jumps >0.8 units in one dose, halt and dilute. If pump runs >2 minutes continuously, shutdown (prevents line rupture). Require redundant pH probes - if they differ by >0.3 units, stop all dosing.", "logic": "```python\nimport time\nimport logging\n\nclass EmergencypHController:\n    def __init__(self, current_ph, target_ph, reservoir_volume):\n        self.current_ph = current_ph\n        self.target_ph = target_ph\n        self.volume = reservoir_volume  # liters\n        self.koh_solution_normality = 1.0  # 1N KOH = 56g/L\n        self.max_dose_percent = 0.05  # 5% of calculated per dose\n        self.mixing_time = 900  # 15 minutes in seconds\n        self.max_ph_rate = 0.5  # pH units per hour max change\n        self.pump_flow_rate = 0.1  # L/min (adjust for your pump)\n        self.safety_shutdown = False\n        \n        # Calculate theoretical total KOH needed (worst case, no buffering)\n        self.h_plus_current = 10 ** (-self.current_ph) * 1000  # mmol/L\n        self.h_plus_target = 10 ** (-self.target_ph) * 1000\n        self.mmol_h_to_neutralize = (self.h_plus_current - self.h_plus_target) * self.volume\n        self.liters_koh_theoretical = self.mmol_h_to_neutralize / self.koh_solution_normality / 1000\n        self.grams_koh_theoretical = self.liters_koh_theoretical * 56\n        \n        logging.basicConfig(level=logging.INFO)\n        self.logger = logging.getLogger(__name__)\n        \n    def inject_dose(self):\n        \"\"\"Inject single safe dose and monitor\"\"\"\n        if self.safety_shutdown:\n            self.logger.critical(\"SYSTEM IN SAFETY SHUTDOWN - MANUAL RESET REQUIRED\")\n            return False\n            \n        # Calculate conservative dose (5% of theoretical)\n        dose_volume = self.liters_koh_theoretical * self.max_dose_percent\n        \n        # Safety cap: never exceed 2L per dose regardless of calculation\n        dose_volume = min(dose_volume, 2.0)\n        \n        # Calculate injection time\n        injection_time = (dose_volume / self.pump_flow_rate) * 60  # seconds\n        \n        # Safety: max continuous pump runtime 120 seconds\n        if injection_time > 120:\n            self.logger.warning(f\"Dose time {injection_time}s exceeds 120s limit - reducing dose\")\n            dose_volume = (120 / 60) * self.pump_flow_rate\n            injection_time = 120\n        \n        pre_dose_ph = self.read_ph_sensors()\n        self.logger.info(f\"DOSE #{self.dose_count}: {dose_volume:.3f}L 1N KOH over {injection_time:.1f}s\")\n        self.logger.info(f\"Pre-dose pH: {pre_dose_ph:.2f} | Target pH: {self.target_ph:.2f}\")\n        \n        # ACTIVATE PUMP\n        self.pump_on()\n        time.sleep(injection_time)\n        self.pump_off()\n        \n        # MIXING PHASE - CRITICAL\n        self.logger.info(f\"Mixing for {self.mixing_time}s...\")\n        mixing_start = time.time()\n        while (time.time() - mixing_start) < self.mixing_time:\n            time.sleep(30)\n            # Check circulation pump status\n            if not self.circulation_pump_ok():\n                self.logger.error(\"Circulation pump failure - halting\")\n                self.safety_shutdown = True\n                return False\n        \n        # POST-DOSE MEASUREMENT\n        post_dose_ph = self.read_ph_sensors()\n        ph_change = post_dose_ph - pre_dose_ph\n        \n        self.logger.info(f\"Post-dose pH: {post_dose_ph:.2f} (\u0394{ph_change:+.2f})\")\n        \n        # SAFETY CHECKS\n        if ph_change > 0.8:\n            self.logger.critical(f\"pH jump {ph_change:.2f} exceeds 0.8 limit - DILUTION REQUIRED\")\n            self.safety_shutdown = True\n            return False\n            \n        if ph_change < 0.05 and dose_volume > 0.1:\n            self.logger.warning(\"Minimal pH change - possible buffering or sensor fouling\")\n        \n        # Update current state\n        self.current_ph = post_dose_ph\n        \n        # Check if target reached\n        if self.current_ph >= (self.target_ph - 0.2):\n            self.logger.info(\"TARGET pH REACHED - Switching to maintenance mode\")\n            return False  # Signal completion\n        \n        # Rate limiting check\n        if ph_change > (self.max_ph_rate / 4):  # Per 15-min dose\n            self.logger.warning(\"Correction rate too high - extending next mixing period\")\n            self.mixing_time = min(self.mixing_time + 300, 1800)  # Up to 30 min\n        \n        return True  # Continue dosing\n    \n    def read_ph_sensors(self):\n        \"\"\"Read redundant pH sensors with validation\"\"\"\n        # Simulated - replace with actual ADC reads\n        probe1 = self.simulate_ph_reading()\n        probe2 = self.simulate_ph_reading()\n        \n        if abs(probe1 - probe2) > 0.3:\n            self.logger.error(f\"Probe disagreement: {probe1:.2f} vs {probe2:.2f}\")\n            self.safety_shutdown = True\n            return min(probe1, probe2)  # Conservative estimate\n        \n        return (probe1 + probe2) / 2\n    \n    def emergency_protocol(self):\n        \"\"\"Main emergency correction loop\"\"\"\n        self.logger.critical(\"=== EMERGENCY pH CORRECTION INITIATED ===\")\n        self.logger.critical(f\"Initial pH: {self.current_ph} | Target: {self.target_ph} | Volume: {self.volume}L\")\n        self.logger.critical(f\"Theoretical KOH needed: {self.grams_koh_theoretical:.0f}g\")\n        \n        self.dose_count = 0\n        start_time = time.time()\n        \n        while self.current_ph < (self.target_ph - 0.2):\n            self.dose_count += 1\n            \n            if self.dose_count > 50:\n                self.logger.critical(\"Max doses exceeded - system problem suspected\")\n                break\n            \n            if not self.inject_dose():\n                break\n            \n            # Progress logging\n            elapsed = (time.time() - start_time) / 3600\n            self.logger.info(f\"Progress: {self.current_ph:.2f}/{self.target_ph:.2f} | Time: {elapsed:.2f}h\")\n            \n            # Prevent thermal runaway in pump\n            time.sleep(30)  # Cooldown between doses\n        \n        self.logger.info(\"=== CORRECTION SEQUENCE COMPLETED ===\")\n        return self.current_ph\n\n    # Hardware interface stubs - implement for your system\n    def pump_on(self): pass\n    def pump_off(self): pass\n    def circulation_pump_ok(self): return True\n    def simulate_ph_reading(self): return self.current_ph + 0.3  # Simulated response\n\n# USAGE\ncontroller = EmergencypHController(current_ph=2.8, target_ph=6.2, reservoir_volume=5000)\nfinal_ph = controller.emergency_protocol()\n```", "safety": "**CRITICAL SAFETY WARNINGS - READ BEFORE EXECUTION**\n\n1. **OVER-CORRECTION = ECOSYSTEM DEATH**: Overshooting to pH >7.5 will convert ammonium to toxic ammonia-NH3 and precipitate essential minerals (iron, phosphate, calcium). This is MORE lethal than the original acid condition. Never exceed target pH by more than 0.3 units.\n\n2. **PUMP CATASTROPHIC FAILURE RISK**: Continuous duty on peristaltic pumps causes tube rupture and chemical spray. **Limit injections to 120 seconds maximum** with 30-second cooldowns. Have chemical spill kit and PPE (face shield, acid-resistant gloves, apron) immediately accessible.\n\n3. **pH SENSOR LAG = DEADLY TRAP**: At pH extremes, probes can take 2-5 minutes to stabilize. Dosing before true reading causes exponential overshoot. **Always wait full mixing period** even if reading looks stable early. Use 3 redundant probes - if any disagree by >0.3, halt immediately.\n\n4. **BUFFERING CAPACITY UNKNOWN**: Theoretical calculations assume pure water. Actual acid sources (sulfuric, nitric, organic acids) have different neutralization curves. **Your 1,850g KOH estimate could be 50% wrong**. The incremental 5% dosing strategy is non-negotiable.\n\n5. **HEAT GENERATION**: Neutralizing strong acid with strong base is exothermic. 5000L at pH 2.8 could raise temperature 5-10\u00b0C if dosed too fast, killing biology and warping reservoir. Slow dosing prevents thermal shock.\n\n6. **PRECIPITATION CASCADE**: As pH rises, dissolved metals (Al, Fe, Mn) will precipitate. This can clog irrigation and smother organisms. Monitor turbidity - if water clouds, stop dosing and filter before continuing.\n\n7. **CHEMICAL PURITY**: Use lab-grade KOH. Agricultural-grade contains impurities that cause violent reactions at high concentrations. Dissolve in RO water only - never tap water.\n\n8. **LEGAL/ENVIRONMENTAL**: pH 2.8 discharge may violate EPA/CWA regulations. Document all actions. If reservoir feeds natural waterways, contain until pH >5.5 minimum.\n\n**EMERGENCY CONTACTS**: Have poison control, chemical spill hotline, and agronomist on speed dial. Post SDS for KOH at dosing station. This is industrial chemical handling, not routine adjustment."}
