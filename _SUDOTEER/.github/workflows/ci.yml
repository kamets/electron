# _SUDOTEER CI/CD Pipeline
# Runs tests, linting, and security checks on every push and PR

name: _SUDOTEER CI

on:
  push:
    branches: [main, develop]
    paths:
      - "backend/**"
      - "tests/**"
      - "requirements*.txt"
      - ".github/workflows/**"
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

env:
  PYTHON_VERSION: "3.11"

jobs:
  # =============================================
  # Job 1: Unit & Integration Tests
  # =============================================
  test:
    name: 游빍 Tests
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout Repository
        uses: actions/checkout@v4

      - name: 游냀 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: 游닍 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-web.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: 游빍 Run Unit Tests
        run: |
          python -m pytest tests/ -v --tb=short --junitxml=test-results.xml

      - name: 游늵 Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

      - name: 游눫 Test Summary
        if: always()
        run: |
          echo "### 游빍 Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Tests completed. See artifacts for detailed results." >> $GITHUB_STEP_SUMMARY

  # =============================================
  # Job 2: Code Coverage
  # =============================================
  coverage:
    name: 游늵 Coverage
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: 游닌 Checkout Repository
        uses: actions/checkout@v4

      - name: 游냀 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: 游닍 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-web.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: 游늵 Run Coverage
        run: |
          python -m pytest tests/ --cov=backend --cov-report=xml --cov-report=html

      - name: 游닋 Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: 游늳 Coverage Summary
        run: |
          echo "### 游늵 Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "Coverage report generated. See artifacts for details." >> $GITHUB_STEP_SUMMARY

  # =============================================
  # Job 3: Security Scan
  # =============================================
  security:
    name: 游 Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout Repository
        uses: actions/checkout@v4

      - name: 游냀 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 游 Run Safety Check
        run: |
          pip install safety
          safety check -r requirements-web.txt --output json || true

      - name: 游댌 Run Bandit Security Linter
        run: |
          pip install bandit
          bandit -r backend/ -f json -o bandit-report.json || true

      - name: 游닋 Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: bandit-report.json

  # =============================================
  # Job 4: Lint & Type Check
  # =============================================
  lint:
    name: 游댌 Lint
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout Repository
        uses: actions/checkout@v4

      - name: 游냀 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 游닍 Install Linters
        run: |
          pip install ruff mypy

      - name: 游댌 Run Ruff Linter
        run: |
          ruff check backend/ --output-format=github || true

      - name: 游닇 Lint Summary
        run: |
          echo "### 游댌 Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "Linting completed." >> $GITHUB_STEP_SUMMARY

  # =============================================
  # Job 5: Safety-Critical Tests
  # =============================================
  safety-critical:
    name: 丘멆잺 Safety-Critical Tests
    runs-on: ubuntu-latest

    steps:
      - name: 游닌 Checkout Repository
        uses: actions/checkout@v4

      - name: 游냀 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: 游닍 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-web.txt
          pip install pytest pytest-asyncio

      - name: 丘멆잺 Run Safety-Critical Tests
        run: |
          # Run only safety and security related tests
          python -m pytest tests/test_safety_watchdog.py tests/test_security_audit.py -v --tb=short

      - name: 游뚿 Safety Status
        run: |
          echo "### 丘멆잺 Safety-Critical Tests" >> $GITHUB_STEP_SUMMARY
          echo "All safety-critical paths verified." >> $GITHUB_STEP_SUMMARY
